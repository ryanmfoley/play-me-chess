function Cell(e,o){this.row=e,this.col=o,this.color="",this.piece="",this.cellBox=document.querySelectorAll(`.rows-${e}`)[o]}class Board{constructor(){this.board=new Array(8);for(let e=0;e<8;e++)this.board[e]=new Array(8);for(let o=0;o<8;o++)for(let e=0;e<8;e++)this.board[o][e]=new Cell(o,e);this.turn="white",this.boardPosition=[],this.draw=!1,this.staleMate=!1}assignPieceToSquare(e){this.board[e.row][e.col].color=e.color,this.board[e.row][e.col].piece=e}checkDraw(){const e=this.board.map(e=>e.filter(e=>e.piece)).flat();this.draw=!0;let o=0,t=0,s=0,r=0,i=0,c=0,a=0;e.forEach(({piece:e})=>{switch(e.name){case"pawn":o++;break;case"knight":"white"===e.color?t++:s++;break;case"bishop":"white"===e.color?r++:i++;break;case"rook":c++;break;case"queen":a++}}),!this.checkThreefoldRepetition()&&(o||c||a||2===r||2===i||t&&r||s&&i)&&(this.draw=!1)}checkThreefoldRepetition(){const t=JSON.stringify(this.board.map(e=>e.map(e=>{var{piece:{name:o,color:t,row:s,col:r,enPassant:i,moved:e}}=e;return{name:o,color:t,row:s,col:r,enPassant:i,moved:e}})))+this.turn;if(this.boardPosition.push(t),3===this.boardPosition.reduce((e,o)=>e+(o===t),0))return!0}clearBoard(){this.board.forEach(e=>e.forEach(e=>e.cellBox.innerHTML=""))}copyBoard({board:e}){this.board=[...e].map(e=>[...e].map(e=>({...e})))}displayPieces(){this.board.forEach(e=>e.forEach(e=>{if(e.cellBox.innerHTML="",e.piece){const s=document.createElement("img");var{color:o,piece:{name:t}}=e;s.src=`./images/${o}-${t}.svg`,s.className="white"===o?"piece":"piece black-piece",s.draggable=!0,e.cellBox.append(s)}}))}identifyCell(e){const o=("board"===e.parentElement.id?e:e.parentElement).classList;var[t]=o[0].match(/\d+/),[e]=o[1].match(/\d+/);return{row:t,col:e}}markEnemySquares(e,o){e.pieces.forEach(e=>e.clearTargetSquares()),o.pieces.forEach(e=>e.clearTargetSquares()),e.pieces.forEach(e=>e.markEnemySquares(this.board)),o.pieces.forEach(e=>e.markEnemySquares(this.board)),this.whiteSquares="white"===e.color?e.pieces.map(e=>e.targets):o.pieces.map(e=>e.targets),this.blackSquares="white"===e.color?o.pieces.map(e=>e.targets):e.pieces.map(e=>e.targets)}markEnPassantPawns(e){var o="white"===e.color?e.col-1:e.col+1,t="white"===e.color?e.col+1:e.col-1;this.board[e.row][o]&&this.board[e.row][o].piece&&this.board[e.row][o].piece.color!==e.color&&(e.enPassant=!0,this.board[e.row][o].piece.enPassant=!0),this.board[e.row][t]&&this.board[e.row][t].piece&&this.board[e.row][t].piece.color!==e.color&&(e.enPassant=!0,this.board[e.row][t].piece.enPassant=!0)}movePiece(e,o,t,s){const r=e.color===this.turn?o:e,i=e.color===this.turn?e:o;e=t.row;this.removePieceFromSquare(t),s.piece?this.removePieceFromGame(r,s.piece):!t.enPassant||(o=("white"===t.color?this.board[s.row+1]:this.board[s.row-1])[s.col].piece)&&(this.removePieceFromSquare(o),this.removePieceFromGame(i,o)),t.changePosition(s),this.assignPieceToSquare(t),this.markEnemySquares(r,i),"king"!==t.name&&"rook"!==t.name||(t.moved=!0),r.pieces.forEach(e=>e.enPassant=!1),i.pieces.forEach(e=>e.enPassant=!1),"pawn"===t.name&&2===Math.abs(e-s.row)&&this.markEnPassantPawns(t)}removePieceFromGame({pieces:e},o){e=e.filter(e=>e.row!==o.row||e.col!==o.col)}removePieceFromSquare({row:e,col:o}){this.board[e][o].color="",this.board[e][o].piece=""}selectSquare({row:e,col:o}){return this.board[e][o]}}const chessBoard=new Board;import{chessBoard}from"./board.js";import{placePiecesOnBoard}from"./pieces.js";import{whitePlayer,blackPlayer}from"./players.js";const audio=document.querySelector("audio"),board=document.querySelector("#board"),squares=document.querySelectorAll(".square"),leaveGameButton=document.querySelector("#leave-game-btn"),logOutForm=document.getElementById("logout-form"),logOutButton=document.getElementById("logout-btn"),gameInfoModal=document.querySelector("#game-info-modal"),gameInfo=document.querySelector(".game-info"),gameResult=document.querySelector(".game-result"),socket=io();let legalMove=!0,selectedCell,selectedPiece,landingCell,landingSquare,player,opponent;function handleDragStart(e){var o,{turn:t}=chessBoard;player.color===t&&(selectedCell=chessBoard.identifyCell(e.target),(o=chessBoard.selectSquare(selectedCell)).color===t&&(selectedPiece=o.piece,setTimeout(()=>e.target.style.display="none",0)))}function handleDrop(e){e.preventDefault(),this.classList.remove("hover-border");var{turn:o}=chessBoard,t=e.target;landingCell=chessBoard.identifyCell(t),landingSquare=chessBoard.selectSquare(landingCell);var{validMove:e,castle:t}=selectedPiece.checkMove(player,opponent,chessBoard,landingSquare);legalMove=e,selectedPiece=legalMove?(t.validCastle&&(socket.emit("movePiece",{selectedCell:selectedCell,landingCell:landingCell}),selectedCell=t.rooksStartingSquare,landingCell=t.rooksLandingSquare),socket.emit("movePiece",{turn:o,selectedCell:selectedCell,landingCell:landingCell}),!1):(legalMove=!0,null)}function handleDragEnter(e){e.preventDefault(),this.classList.add("hover-border")}function handleDragLeave(){this.classList.remove("hover-border")}function handleDragEnd(e){setTimeout(()=>e.target.style.display="block",0)}function handleDragOver(e){e.preventDefault()}socket.emit("enterGameRoom"),socket.on("enterGameRoom",({id:e,color:o})=>{player="white"===o?whitePlayer:blackPlayer,opponent="white"===o?blackPlayer:whitePlayer,player.id=e,"white"===o?(gameInfoModal.style.visibility="visible",gameInfo.style.display="block",gameInfo.innerHTML="Waiting for opponent..."):(board.classList.add("black-piece"),gameInfo.classList.add("black-piece"),gameResult.classList.add("black-piece"))}),socket.on("startGame",()=>{gameInfoModal.style.visibility="hidden",gameInfo.style.display="none",chessBoard.clearBoard(),placePiecesOnBoard(chessBoard),chessBoard.displayPieces(),chessBoard.markEnemySquares(player,opponent)});for(const Ga of squares)Ga.addEventListener("dragstart",handleDragStart,!1),Ga.addEventListener("dragenter",handleDragEnter,!1),Ga.addEventListener("dragover",handleDragOver,!1),Ga.addEventListener("dragleave",handleDragLeave,!1),Ga.addEventListener("drop",handleDrop,!1),Ga.addEventListener("dragend",handleDragEnd,!1);socket.on("movePiece",async({turn:o,selectedCell:t,landingCell:e})=>{chessBoard.turn=o;const s=player.color===chessBoard.turn?opponent:player,r=player.color===chessBoard.turn?player:opponent;var i=chessBoard.selectSquare(t),t=chessBoard.selectSquare(e),i=i.piece,e="pawn"===i.name&&("white"===o?7:0)==e.row;if(chessBoard.movePiece(player,opponent,i,t,socket),chessBoard.displayPieces(),e){let e;player.color!==o?(e=await player.selectPieceModal(),socket.emit("promotePawn",e)):e=await opponent.getPromotedPiece(socket);var c=s.promotePawn(i,e);chessBoard.movePiece(s,r,c,t),chessBoard.displayPieces()}chessBoard.markEnemySquares(player,opponent),chessBoard.checkDraw(),r.isKingInCheck(chessBoard),r.checkEscapeMoves(chessBoard,s),r.inCheck?({row:c,col:t}=r.kingSquare,chessBoard.board[c][t].cellBox.id="check-square",audio.play()):chessBoard.board.forEach(e=>e.forEach(e=>e.cellBox.removeAttribute("id"))),r.checkMate?(gameResult.innerHTML="Checkmate",setTimeout(function(){gameInfoModal.style.visibility="visible",gameResult.style.display="block"},500),setTimeout(function(){window.location.href="/lobby"},2e3)):chessBoard.draw?(gameResult.innerHTML="Draw",setTimeout(function(){gameInfoModal.style.visibility="visible",gameResult.style.display="block"},500),setTimeout(function(){window.location.href="/lobby"},2e3)):chessBoard.staleMate&&(gameResult.innerHTML="Stalemate",setTimeout(function(){gameInfoModal.style.visibility="visible",gameResult.style.display="block"},2e3),setTimeout(function(){window.location.href="/lobby"},2e3))}),socket.on("leaveGame",e=>{e&&player.id!==e&&(gameInfoModal.style.visibility="visible",gameInfo.style.display="block",gameInfo.innerHTML="Opponent left game",socket.emit("updatePlayersWaiting",player.id),setTimeout(()=>{window.location.href="/lobby"},1e3))}),leaveGameButton.addEventListener("click",()=>{socket.emit("leaveGame",player.id),socket.emit("updatePlayersWaiting",player.id),window.location.href="/lobby"}),logOutButton.addEventListener("click",()=>{socket.emit("leaveGame",player.id),socket.emit("logout"),socket.on("logout",({id:e})=>{socket.emit("updatePlayersWaiting",e)}),logOutForm.submit()}),window.addEventListener("beforeunload",()=>{socket.emit("leaveGame",player.id),socket.emit("logout")});const username=window.document.cookie.split("=")[1],createGameBtn=document.querySelector("#create-game-btn"),logOutBtn=document.querySelector("#logout-btn"),logOutForm=document.querySelector("#logout-form"),lobbyTable=document.querySelector("#lobby-table tbody"),socket=io();function generateTable(e){lobbyTable.innerHTML="";for(let e=0;e<5;e++){const o=lobbyTable.insertRow();o.insertCell(),o.insertCell()}e.forEach(({username:e,id:o},t)=>{e=document.createTextNode(e);const s=document.createElement("button");if(s.innerText="Play Me",s.className="join-game-btn w-75 btn btn-dark",s.onclick=()=>{socket.emit("updatePlayersWaiting",o),socket.emit("joinGame",{id:o,color:"black"}),setTimeout(()=>{window.location.href="/chess"},100)},t<5){const[r,i]=document.querySelectorAll("tbody > tr")[t].cells;r.innerHTML="<td></td>",r.appendChild(e),i.innerHTML="<td></td>",i.appendChild(s),i.classList.add("text-center")}else{const c=lobbyTable.insertRow(),a=c.insertCell(),l=c.insertCell();a.innerHTML="<td></td>",a.appendChild(e),l.innerHTML="<td></td>",l.appendChild(s),l.classList.add("text-center")}})}socket.emit("login",username),socket.on("playersWaiting",e=>{generateTable(e)}),createGameBtn.addEventListener("click",()=>{socket.emit("joinGame",{color:"white"}),window.location.href="/chess"}),logOutBtn.addEventListener("click",()=>{socket.emit("logout"),socket.on("logout",({id:e})=>{socket.emit("updatePlayersWaiting",e)}),logOutForm.submit()});class Piece{constructor(e,o,t,s){this.color=e,this.name=o,this.row=t,this.col=s,this.enPassant=!1,this.targets=[]}changePosition({row:e,col:o}){this.row=e,this.col=o}checkMove(e,o,t,s){let{validMove:r,castle:i}=this.checkForValidMove(e,o,t,s),c=Object.assign(Object.create(Object.getPrototypeOf(t)),t);c.copyBoard(t);const a=e.copyPlayer();e=o.copyPlayer(),o=a.pieces.find(e=>e.row===this.row&&e.col===this.col);return r&&c.movePiece(a,e,o,s),c.markEnemySquares(a,e),a.isKingInCheck(c),(a.inCheck||s.piece&&"king"===s.piece.name)&&(r=!1),{validMove:r,castle:i}}clearTargetSquares(){this.targets=[]}}class Pawn extends Piece{constructor(e,o,t,s){super(e,o,t,s)}checkForValidMove(e,o,t,s){var r="white"===this.color?6:1,i="white"===this.color?this.row-1:this.row+1,c="white"===this.color?this.row-2:this.row+2;let a;return this.col===s.col&&!s.piece&&s.row===i||this.col===s.col&&this.row===r&&s.row===c&&!s.piece||1===Math.abs(this.row-s.row)&&1===Math.abs(this.col-s.col)&&s.piece&&this.color!==s.piece.color?a=!0:this.enPassant?(c=o.pieces.find(e=>e.enPassant),o="white"===this.color?c.row-1:c.row+1,s.row===o&&s.col===c.col&&(a=!0)):a=!1,{validMove:a,castle:{validCastle:!1}}}markEnemySquares(e){let o;o="white"===this.color?0<this.row?this.row-1:null:this.row<7?this.row+1:null;var t=0<this.col?this.col-1:null,s=this.col<7?this.col+1:null;null!==o&&(null!==t&&this.targets.push({row:o,col:t}),null!==s&&this.targets.push({row:o,col:s}))}}class Knight extends Piece{constructor(e,o,t,s){super(e,o,t,s)}checkForValidMove(e,o,t,s){let r;return r=1===Math.abs(this.row-s.row)&&2===Math.abs(this.col-s.col)&&this.color!==s.piece.color||2===Math.abs(this.row-s.row)&&1===Math.abs(this.col-s.col)&&this.color!==s.piece.color,{validMove:r,castle:{validCastle:!1}}}markEnemySquares(e){for(let o=this.row-2;o<=this.row+2;o++)for(let e=this.col-2;e<=this.col+2;e++)(2===Math.abs(this.row-o)&&1===Math.abs(this.col-e)||1===Math.abs(this.row-o)&&2===Math.abs(this.col-e))&&0<=o&&o<=7&&0<=e&&e<=7&&this.targets.push({row:o,col:e})}}class Bishop extends Piece{constructor(e,o,t,s){super(e,o,t,s)}checkForValidMove(e,o,s,r){let i;if(Math.abs(this.row-r.row)===Math.abs(this.col-r.col)){let t=!1;if(r.row<this.row&&r.col<this.col){let e=this.row-1,o=this.col-1;for(;e>r.row&&o>r.col;e--,o--)s.board[e][o].piece&&(t=!0)}else if(r.row<this.row&&r.col>this.col){let e=this.row-1,o=this.col+1;for(;e>r.row&&o<r.col;e--,o++)s.board[e][o].piece&&(t=!0)}else if(r.row>this.row&&r.col<this.col){let e=this.row+1,o=this.col-1;for(;e<r.row&&o>r.col;e++,o--)s.board[e][o].piece&&(t=!0)}else if(r.row>this.row&&r.col>this.col){let e=this.row+1,o=this.col+1;for(;e<r.row&&o<r.col;e++,o++)s.board[e][o].piece&&(t=!0)}i=!t&&r.piece.color!==this.color}return{validMove:i,castle:{validCastle:!1}}}markEnemySquares(e){let o=this.row-1,t=this.col-1;for(;0<=o&&0<=t&&(this.targets.push({row:o,col:t}),!e[o][t].piece);o--,t--);for(o=this.row-1,t=this.col+1;0<=o&&t<=7&&(this.targets.push({row:o,col:t}),!e[o][t].piece);o--,t++);for(o=this.row+1,t=this.col-1;o<=7&&0<=t&&(this.targets.push({row:o,col:t}),!e[o][t].piece);o++,t--);for(o=this.row+1,t=this.col+1;o<=7&&t<=7&&(this.targets.push({row:o,col:t}),!e[o][t].piece);o++,t++);}}class Rook extends Piece{constructor(e,o,t,s){super(e,o,t,s)}checkForValidMove(e,o,t,s){let r,i;if(s.col<this.col&&s.row===this.row){for(let e=this.col-1;e>s.col;e--)t.board[this.row][e].piece&&(i=!0);r=!0}else if(s.col>this.col&&s.row===this.row){for(let e=this.col+1;e<s.col;e++)t.board[this.row][e]&&t.board[this.row][e].piece&&(i=!0);r=!0}else if(s.row<this.row&&s.col===this.col){for(let e=this.row-1;e>s.row;e--)t.board[e][this.col].piece&&(i=!0);r=!0}else if(s.row>this.row&&s.col===this.col){for(let e=this.row+1;e<s.row;e++)t.board[e][this.col].piece&&(i=!0);r=!0}return r=!(!r||i||s.piece.color===this.color),{validMove:r,castle:{validCastle:!1}}}markEnemySquares(o){for(let e=this.col-1;0<=e&&(this.targets.push({row:this.row,col:e}),!o[this.row][e].piece);e--);for(let e=this.col+1;e<=7&&(this.targets.push({row:this.row,col:e}),!o[this.row][e].piece);e++);for(let e=this.row-1;0<=e&&(this.targets.push({row:e,col:this.col}),!o[e][this.col].piece);e--);for(let e=this.row+1;e<=7&&(this.targets.push({row:e,col:this.col}),!o[e][this.col].piece);e++);}}class Queen extends Piece{constructor(e,o,t,s){super(e,o,t,s)}checkForValidMove(e,o,s,r){return{validMove:(()=>{if(Math.abs(this.row-r.row)===Math.abs(this.col-r.col)){let t=!1;if(r.row<this.row&&r.col<this.col){let e=this.row-1,o=this.col-1;for(;e>r.row&&o>r.col;e--,o--)s.board[e][o].piece&&(t=!0)}else if(r.row<this.row&&r.col>this.col){let e=this.row-1,o=this.col+1;for(;e>r.row&&o<r.col;e--,o++)s.board[e][o].piece&&(t=!0)}else if(r.row>this.row&&r.col<this.col){let e=this.row+1,o=this.col-1;for(;e<r.row&&o>r.col;e++,o--)s.board[e][o].piece&&(t=!0)}else if(r.row>this.row&&r.col>this.col){let e=this.row+1,o=this.col+1;for(;e<r.row&&o<r.col;e++,o++)s.board[e][o].piece&&(t=!0)}if(!t&&r.piece.color!==this.color)return!0}return!1})()||(()=>{let e,o;if(r.col<this.col&&r.row===this.row){for(let e=this.col-1;e>r.col;e--)s.board[this.row][e].piece&&(o=!0);e=!0}else if(r.col>this.col&&r.row===this.row){for(let e=this.col+1;e<r.col;e++)s.board[this.row][e]&&s.board[this.row][e].piece&&(o=!0);e=!0}else if(r.row<this.row&&r.col===this.col){for(let e=this.row-1;e>r.row;e--)s.board[e][this.col].piece&&(o=!0);e=!0}else if(r.row>this.row&&r.col===this.col){for(let e=this.row+1;e<r.row;e++)s.board[e][this.col].piece&&(o=!0);e=!0}return!(!e||o||r.piece.color===this.color)})(),castle:{validCastle:!1}}}markEnemySquares(t){(()=>{let e=this.row-1,o=this.col-1;for(;0<=e&&0<=o&&(this.targets.push({row:e,col:o}),!t[e][o].piece);e--,o--);for(e=this.row-1,o=this.col+1;0<=e&&o<=7&&(this.targets.push({row:e,col:o}),!t[e][o].piece);e--,o++);for(e=this.row+1,o=this.col-1;e<=7&&0<=o&&(this.targets.push({row:e,col:o}),!t[e][o].piece);e++,o--);for(e=this.row+1,o=this.col+1;e<=7&&o<=7&&(this.targets.push({row:e,col:o}),!t[e][o].piece);e++,o++);})(),(()=>{for(let e=this.col-1;0<=e&&(this.targets.push({row:this.row,col:e}),!t[this.row][e].piece);e--);for(let e=this.col+1;e<=7&&(this.targets.push({row:this.row,col:e}),!t[this.row][e].piece);e++);for(let e=this.row-1;0<=e&&(this.targets.push({row:e,col:this.col}),!t[e][this.col].piece);e--);for(let e=this.row+1;e<=7&&(this.targets.push({row:e,col:this.col}),!t[e][this.col].piece);e++);})()}}class King extends Piece{constructor(e,o,t,s){super(e,o,t,s)}checkForValidMove(e,o,t,s){const r="white"===this.color?t.blackSquares:t.whiteSquares;var i=r.find(e=>e===s);let c;"white"===this.color&&this.row===s.row?c=this.col<s.col?"right":"left":"black"===this.color&&this.row===s.row&&(c=this.col<s.col?"left":"right");let a={validCastle:!1},l,h,n,d,w;if("white"===this.color&&"right"===c&&2===Math.abs(this.col-s.col)||"black"===this.color&&"left"===c&&2===Math.abs(this.col-s.col)){l=!0;const u=t.board[this.row].slice(this.col+1,s.col+1);var p=t.board[this.row][7].piece;a.rooksStartingSquare={row:p.row,col:7},a.rooksLandingSquare={row:p.row,col:this.col+1},a.rook=p,w=p.moved,u.forEach(o=>{r.forEach(e=>{o.row===e.row&&o.col===e.col&&(n=!0)})}),u.forEach(e=>{e.piece&&(h=!0)})}else if("white"===this.color&&"left"===c&&2===Math.abs(this.col-s.col)||"black"===this.color&&"right"===c&&2===Math.abs(this.col-s.col)){l=!0;const m=t.board[this.row].slice(s.col-1,this.col);t=t.board[this.row][0].piece;a.rooksStartingSquare={row:t.row,col:0},a.rooksLandingSquare={row:t.row,col:this.col-1},a.rook=t,w=t.moved,m.forEach(o=>{r.forEach(e=>{o.row===e.row&&o.col===e.col&&(n=!0)})}),m.forEach(e=>{e.piece&&(h=!0)})}return e.inCheck||this.moved||w||!a.rook||a.rook.row!==a.rooksStartingSquare.row||a.rook.col!==a.rooksStartingSquare.col||!l||h||n||(a.validCastle=!0,d=!0),Math.abs(this.row-s.row)<=1&&Math.abs(this.col-s.col)<=1&&s.color!==this.color&&!i&&(d=!0),{validMove:d,castle:a}}markEnemySquares(e){var t=0<=this.row-1?this.row-1:0,s=this.row+1<=7?this.row+1:7,r=0<=this.col-1?this.col-1:0,i=this.col+1<=7?this.col+1:7;for(let o=t;o<=s;o++)for(let e=r;e<=i;e++)this.row===o&&this.col===e||this.targets.push({row:o,col:e})}}const whitePieces=[],blackPieces=[];for(let o of["white","black"])for(let e=0;e<8;e++)"white"===o?whitePieces.push(new Pawn("white","pawn",6,e)):blackPieces.push(new Pawn("black","pawn",1,e));whitePieces.push(new Knight("white","knight",7,1)),whitePieces.push(new Knight("white","knight",7,6)),whitePieces.push(new Bishop("white","bishop",7,2)),whitePieces.push(new Bishop("white","bishop",7,5)),whitePieces.push(new Rook("white","rook",7,0)),whitePieces.push(new Rook("white","rook",7,7)),whitePieces.push(new Queen("white","queen",7,3)),whitePieces.push(new King("white","king",7,4)),blackPieces.push(new Knight("black","knight",0,1)),blackPieces.push(new Knight("black","knight",0,6)),blackPieces.push(new Bishop("black","bishop",0,2)),blackPieces.push(new Bishop("black","bishop",0,5)),blackPieces.push(new Rook("black","rook",0,0)),blackPieces.push(new Rook("black","rook",0,7)),blackPieces.push(new Queen("black","queen",0,3)),blackPieces.push(new King("black","king",0,4));const placePiecesOnBoard=o=>{whitePieces.forEach(e=>{o.assignPieceToSquare(e)}),blackPieces.forEach(e=>{o.assignPieceToSquare(e)})};import{whitePieces,blackPieces}from"./pieces.js";class Player{constructor(e,o){this.color=e,this.pieces=o,this.inCheck=!1,this.checkMate=!1,this.staleMate=!1}get kingSquare(){return this.pieces.find(e=>"king"===e.name)}copyPlayer(){const e=Object.assign(Object.create(Object.getPrototypeOf(this)),this);return e.pieces=[...this.pieces].map(e=>Object.assign(Object.create(Object.getPrototypeOf(e)),e)),e}checkEscapeMoves(e,s){this.escapeCheck=!1;var o,t,{pieces:r}=this.copyPlayer();const i=["knight","queen"];e:for(const h of r){"pawn"===h.name&&(o="white"===h.color?h.row-1:h.row+1,0<=(t="white"===h.color?h.row-2:h.row+2)&&t<=7&&(h.targets.push({row:o,col:h.col}),h.targets.push({row:t,col:h.col}))),"king"!==h.name||h.moved||(h.targets.push({row:h.row,col:h.col-2}),h.targets.push({row:h.row,col:h.col+2}));for(const n of h.targets){let o=!1,t=Object.assign(Object.create(Object.getPrototypeOf(e)),e);t.copyBoard(e);const d=this.copyPlayer(),w=s.copyPlayer(),p=d.pieces.find(e=>e.row===h.row&&e.col===h.col),u=t.selectSquare(n);var c="white"===this.color?0:7,{validMove:a,castle:l}=p.checkMove(d,w,t,u);if(a&&(a="pawn"===p.name&&c==n.row,l.validCastle?(c=t.selectSquare(l.rooksLandingSquare),t.movePiece(d,w,p,u),t.movePiece(d,w,l.rook,c)):a?i.forEach(e=>{e=d.promotePawn(p,{color:this.color,piece:e});t.movePiece(d,w,e,u),t.markEnemySquares(d,w),d.isKingInCheck(t),d.inCheck||(this.escapeCheck=!0,o=!0)}):t.movePiece(d,w,p,u),t.markEnemySquares(d,w),d.isKingInCheck(t),d.inCheck||(this.escapeCheck=!0,o=!0)),o)break e}}this.escapeCheck||(this.inCheck?this.checkMate=!0:e.staleMate=!0)}getPromotedPiece(t){return new Promise(o=>{t.on("promotePawn",e=>{t.off("promotePawn"),o(e)})})}isKingInCheck({whiteSquares:e,blackSquares:o}){const t=("white"===this.color?o:e).flat();try{const{row:s,col:r}=this.kingSquare;t.find(e=>s===e.row&&r===e.col)?this.inCheck=!0:this.inCheck=!1}catch(e){console.error(e)}}promotePawn(e,{piece:o}){var t=this.sparePieces.find(e=>e.name===o);const s=Object.assign(Object.create(Object.getPrototypeOf(t)),t);s.row=e.row,s.col=e.col;e=this.pieces.indexOf(e);return this.pieces[e]=s,s}selectPieceModal(){const t=document.querySelector("#promote-modal");t.innerHTML="","black"===this.color&&t.classList.add("promote-modal-black");for(const e of["knight","bishop","rook","queen"]){const o=document.createElement("img");o.src=`./images/${this.color}-${e}.svg`,o.className="white"===this.color?"piece":"piece black-piece",o.setAttribute("data-piece",e),t.append(o)}return setTimeout(function(){t.style.visibility="visible"},300),new Promise(o=>{t.addEventListener("click",e=>{e={color:this.color,piece:e.target.dataset.piece};t.style.visibility="hidden",o(e)})})}}const whitePlayer=new Player("white",whitePieces),blackPlayer=new Player("black",blackPieces);export{Board,chessBoard,placePiecesOnBoard,whitePieces,blackPieces,whitePlayer,blackPlayer};